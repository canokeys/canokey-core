dist: xenial
sudo: required
language:
  - cpp
compiler:
  - gcc
addons:
  apt:
    update: true
    packages:
      - gcc
      - g++
      - cmake
      - pcscd
      - pcsc-tools
      - libpcsclite-dev
      - libcmocka-dev

script:
  - git clone --depth 1 https://github.com/google/u2f-ref-code.git
  - pushd u2f-ref-code/u2f-tests/HID
  - git clone --depth 1 -b lollipop-release https://android.googlesource.com/platform/system/core
  - cd ../NFC
  - make
  - popd
  -
  - mkdir build && pushd build
  - cmake .. -DENABLE_TESTS=ON -DCMAKE_BUILD_TYPE=Release
  - make -j2
  - popd
  -
  - sudo cp build/libu2f-virt-card.so /usr/local/lib/
  - sudo cp pcscd-reader.conf /etc/reader.conf.d/
  - travis_wait 10 sudo pcscd -a -f 2>&1 |tee /tmp/pcscd.log &
  - timeout 1s pcsc_scan -q || true
  - ./u2f-ref-code/u2f-tests/NFC/u2f_nfc_test -v
after_failure:
  - cat /tmp/pcscd.log
